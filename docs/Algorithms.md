
# Algorithms

Algorithms are the building blocks of BNOPI projects. An algorithm is a script or executable which takes in 0 or more stage instances as input and produces 0 or more stage instances as output.

## Example

<!-- The GEN_STOP_CONNECTION_GRAPH algorithm has an algorithm metadata (*.alg.json*) file, which can be found [here](/bnopi-algs/gen-stop-connection-graph.alg.json). Inside the BNOPI interface, clicking on the cog icon in the GEN_STOP_CONNECTION_GRAPH node on the dependency graph allows us to view some of this information in the Properties tab to the right. -->

In [/bnopi-algs/](/bnopi-algs/) there is an **algorithm metadata file** (*.alg.json*) for an algorithm called [GEN_STOP_CONNECTION_GRAPH](/bnopi-algs/gen-stop-connection-graph.alg.json), which takes as input a STOPS and a ROUTES instance as well as some **parameters**, and outputs at STOP_CONNECTION_GRAPH instance. 

Looking at the *alg.json* file directly, it contains a `name` and `description`, as well as information concerning the algorithm's inputs and outputs. Starting with one of the 2 types of input, this information consists of:

+ The **parameters** - These are settings for the algorithm that can be set by the user before the algorithm is run. For GEN_STOP_CONNECTION_GRAPH the parameters are:

```json
"params": [
	{
		"name": "Left-side drive",
		"type": "dropdown",
		"choices":["left", "right"],
		"default": "left",
		"help": "Specifies that road users should on the left. If omitted, it is assumed road users drive on the right.",
		"var": "DRIVE_ON_LEFT"
	},
	{
		"name": "Max search distance",
		"type": "posint",
		"default": 1000,
		"help": "Specifies the maximum distance to search for neighboring stops, in meters. Defaults to 1000.",
		"var": "MAX_SEARCH_DISTANCE"
	}
]
```

In the UI Properties tab, each parameter generates an input box for the user of the type `type`, which they can use to input the **value** of the parameter. Later, the values that the user inputs are referenced by the name in the `var` property.

+ The **input stage instances**. This is how BNOPI passes data between nodes. We mustspecify the [stage formats](Stage-Formats.md) of the instances. For GEN_STOP_CONNECTION_GRAPH, the input stage formats are:

```json
"inputStageFormats":[
	{
		"name": "Stops",
		"help": "The stops between which to make the stop connection graph edges",
		"var": "STOPS_FILELOC",
		"stage_format": "STOPS"
	},
	{
		"name": "Roads",
		"help": "Roads between the stops",
		"var": "ROADS_FILELOC",
		"stage_format": "ROADS"
	}
]
```

When the GEN_STOP_CONNECTION_GRAPH node is about to run, with the absence of a breakpoint on any parent node, BNOPI will automatically select instances of these formats generated by the parents. If, as is the case in the example project, there *is* a breakpoint, then the user will be allowed to edit the instances generated by previous nodes, and manually select which ones to use for the GEN_STOP_CONNECTION_GRAPH node. The file paths of the selected instances are later referenced by the name in the `var` property.

Algorithms only have 1 type of output:
+ The **output stage instances**. In the *alg.json* file, the `outputStageFormats` refer to the formats of these outputs, in the same way as with the input stage intances:

```json
"outputStageFormats":[
	{
		"name": "Stop connection graph",
		"help": "A json file containing the generated stops",
		"var": "OUTPUT_FILELOC",
		"stage_format": "STOP_CONNECTION_GRAPH"
	}
]
```

When the STOP_CONNECTION_GRAPH node runs, BNOPI automatically assgins a new file location for each output stage instance and generates a corresponding stage instance metadata (*.stg.json*) file.

+ The final part of the *.alg.json* file is the **launch script**. This is resposible for processing the `var`s and launching the algorithm. Currently launch scripts can be written in Python 3 only. In this case the GEN_STOP_CONNECTION_GRAPH algorithm is written in Python 3 also. The launch script for GEN_STOP_CONNECTION_GRAPH is as follows:

```python
#!/usr/bin/env python3
from os import getenv, system, name

# decide whether to include the --drive-on-left flag
dol_flag = ""
if getenv("DRIVE_ON_LEFT") == "left":
    dol_flag = "--drive-on-left"

if name == "nt": # windows. must specify interpreter
    system(
        f'py -3 ../algs/stop-connection-graph.py {dol_flag} -d {getenv("MAX_SEARCH_DISTANCE")} -o "{getenv("OUTPUT_FILELOC")}" "{getenv("STOPS_FILELOC")}" "{getenv("ROADS_FILELOC")}"')
else:
    # otherwise assume we can read the shebang
    system(
        f'../algs/stop-connection-graph.py {dol_flag} -d {getenv("MAX_SEARCH_DISTANCE")} -o "{getenv("OUTPUT_FILELOC")}" "{getenv("STOPS_FILELOC")}" "{getenv("ROADS_FILELOC")}"')
```

The launch script is run with the environment variables `DRIVE_ON_LEFT`, `MAX_SEARCH_DISTANCE`, `STOPS_FILELOC`, `ROADS_FILELOC`, and `OUTPUT_FILELOC` set as required. These variable names are those set from the `var` properties in the *alg.json* file. Additionally, BNOPI sets the environment variables `WORK_AREA_LAT`, `WORK_AREA_LON`, and `WORK_AREA_RADIUS` for all algorithms to specify the circular area centered on the coordinates within which the algorithms should operate. The launch script then substitues these into a command to launch the algorithm.

## *.alg.json* structure
A JSON object containing the following properties:

+ `name: String` - A descriptive name of the algorithm.
+ `id: String` - The id of the algorithm as it is referred to elsewhere in the project
+ `description: String` - A helpful description of what the algorithm does
+ `params: Array` - List of Objects containing about the algorithm's parameters. Each Object contains:
	+ `name: String` - Name of the parameter
	+ `type: String` - Type of the parameter. This affects the type of input box the user will be given in the UI. Currently implemented types are `"dropdown"` for a drowpdown selection input and `"posint"` for a positive integer.
	+ `default: String|Number` - The default value for the parameter.
	+ `help: String` - Helpful message adding extra information about the parameter to the user.
	+ `var: String` - The environment variable which will hold the value of this parameter when the launch script is run.
	+ `choices: Array[String] | undefined` - If the `type` is `"dropdown"`, then `choices` holds a list of the choices the user can select from.
+ `inputStageFormats: Array` - List of Objects specifying the input instances for the algorithm. Each contains:
	+ `name: String` - Name of the input
	+ `help: String` - Helpful message describing the input
	+ `var: String` - The environment variable which will hold the path to the location of the input instance when the launch script is run.
	+ `stage_format: String` - The stage format id of this input.
+ `outputStageFormats - Array` - List of Objects specifying the output instances for the algorithm. Each contains:
	+ `name: String` - Name of the output
	+ `help: String` - Helpful message describing the output
	+ `var: String` - The environment variable which will hold the path to the location to where the output instance is to be written.
	+ `stage_format: String` - The stage format id of this output.
+ `launchScript: Object` - Object containing the different types of launch scripts implemented for this algorithm.
	+ `python3: String` - Currently the only type of launch script supported by BNOPI. This contains a path to a Python 3 launch script for this algorithm.
