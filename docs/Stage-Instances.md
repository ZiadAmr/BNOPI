
# Stage Instances

A **stage instance** is a file that is used as input to, or generated as output from, an [**algorithm**](/docs/Algorithms.md). To keep track of stage instances, for each stage instance BNOPI generates a **stage instance metadata file**, with the file extension *.stg.json*. 

BNOPI searches for *.stg.json* files in directories referenced from the [project's *info.json* file](/docs/Projects.md), but if the project folder was generated using the user interface then this will always be a folder named *stage_instances* inside the project folder.

## Parents and Siblings

Each *.stg.json* file contains JSON Arrays `parentStageInstances` and `siblingStageInstances`.

The **parents** of a stage instance are instances that were used as input to the algorithm that generated it. If the stage instance was instead generated by a user edit in the UI, then the parents are the original instances that were used in the [display framework](/docs/Stage-Formats.md), including the [requirement](/docs/Stage-Formats.md) instances.
`parentStageInstances` contains paths to the *.stg.json* files of the parents in the order that they appeared in the algorithm metdata file, or, in the case of user edit, the primary instance followed by the requirement instances in the order they appeared in the *fmt.js* file.

The **siblings** of a stage instance are other instances that were generated by the same run of an algorithm. For example, if an algorithm generates 2 stage instances, then each instance is a sibling of the other (but not of themselves). If the stage instance was generated by a user edit in the UI, then the sibligs are any other instance that was generated by the [editing framework](/docs/Stage-Formats.md). This will not necessary include new copies of all the parents, as editing frameworks are not required to create such copies for each of the primary instance and requirements.

## Stage instance metadata (*.stg.json*) file structure

The *.stg.json* file contains a JSON Object with the following properties:

+ `timeCreated: string` - The time at which the stage format was created, in the format produced by the javascipt function `Date.toJSON()`
+ `dependencyGraph: string` - Path to the dependency graph file (*.dg.json*) at the point where the stage instance was created. Relative or absolute paths are accepted, but relative paths are recommended as this allows projects to be more easilly copied between decives.
+ `format: string` - The id of the [stage format](/docs/Stage-Formats.md) of this instance
+ `generatedBy: string` - The id of the [algorithm](/docs/Algorithms.md) that generated this stage instance. There are 2 reserved ids, USER_PRIMARY_EDIT and USER_REQUIREMENT_EDIT, which are used if the instance was generated by an editing framework. "PRIMARY"/"REQUIREMENT" refers to the role of this instance in the editing framework.
+ `nodeInGraph` **TODO - currently unused**. Node in the dependency graph that generated the instance. If the instance was generated from a user edit, then `nodeInGraph` refers to the same node that created the original instance.
+ `parentStageInstances: Array[string]` - Paths to the stage instance metadata (*.stg.json*) files of the parents (as described above). Paths relative to the location of this metadata file are preferred.
+ `siblingStageInstances: Array[string]` - Paths to the stage instance metadata (*.stg.json*) files of the siblings (as described above). Paths relative to the location of this metadata file are preferred.
+ `datafile: string` - Path to the actual stage instance. A path relative to the location of this metadata file is preferred.

## Example

Below is the contents of a *.stg.json* file.

```jsonc
{
	"timeCreated": "2023-04-20T10:55:53.687Z",
	"dependencyGraph": "../test_dependency_graph.dg.json",
	"format": "ROUTES",
	"generatedBy": "USER_PRIMARY_EDIT",
	"nodeInGraph": null, /* currently unused */
	"parentStageInstances": [
		"routes.stg.json",
		"stop-connection-graph.stg.json",
		"stops.stg.json"
	],
	"siblingStageInstances": [
		"stops_USER_REQUIREMENT_EDIT_1.stg.json"
	],
	"datafile": "routes_USER_PRIMARY_EDIT_1.json"
}
```

The stage instance being referred to by `"datafile"` was created as the result of a user edit. It was the primary instance in the editing framework for ROUTES, shown by `"generatedBy": "USER_PRIMARY_EDIT"`. The editing framework took 3 instances in total, the primary instance (`"routes.stg.json"`), and 2 requirement instances (`"stop-connection-graph.stg.json"` and `"stops.stg.json"`). The editing framework made a new copy of the routes (this metadata file) and the stops, the latter of which is referenced by the relative path `"stops_USER_REQUIREMENT_EDIT_1.stg.json"`. The editing framework did not create a new version of the stop connection graph, as this does not appear in the siblings.